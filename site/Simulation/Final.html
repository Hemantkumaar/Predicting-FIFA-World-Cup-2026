<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>FIFA 2026 Final</title>

<style>
body{
margin:0;
font-family:system-ui;
background:radial-gradient(circle at center,#111a33,#070b14);
color:white;
text-align:center;
overflow:hidden;
}

.container{
padding:60px 20px;
}

h1{
font-size:42px;
margin-bottom:40px;
}

.finalMatch{
background:rgba(18,28,51,.9);
padding:30px;
border-radius:20px;
border:1px solid rgba(255,255,255,.1);
max-width:700px;
margin:auto;
}

.teams{
display:flex;
justify-content:space-between;
gap:20px;
margin-bottom:20px;
}

.team{
flex:1;
padding:15px;
border-radius:12px;
background:rgba(255,255,255,.05);
font-size:20px;
font-weight:bold;
}

.predictBtn{
margin-top:20px;
padding:12px 24px;
background:#f6c453;
border:none;
border-radius:10px;
font-weight:bold;
font-size:16px;
cursor:pointer;
}

.countdown{
font-size:40px;
margin:20px 0;
color:#f6c453;
font-weight:bold;
}

.champion{
margin-top:30px;
font-size:28px;
font-weight:bold;
}

.trophy{
font-size:80px;
margin-top:20px;
animation:float 2s infinite ease-in-out;
}

@keyframes float{
0%{transform:translateY(0)}
50%{transform:translateY(-10px)}
100%{transform:translateY(0)}
}

canvas{
position:fixed;
top:0;
left:0;
pointer-events:none;
z-index:1000;
}

.resetBtn{
position:fixed;
bottom:30px;
right:30px;
padding:12px 20px;
border-radius:10px;
border:none;
background:#dc3545;
color:white;
font-weight:bold;
cursor:pointer;
}
</style>
</head>

<body>

<canvas id="confetti"></canvas>

<!-- persistent soundtrack for tournament flow; local file -->
<audio id="globalSong" src="champion.mp3" preload="auto"></audio>

<!-- Global Audio Player UI -->
<div style="position:fixed;bottom:20px;right:20px;z-index:9999;background:rgba(0,0,0,.95);padding:10px 12px;border-radius:8px;border:2px solid #f6c453;display:flex;align-items:center;gap:8px;font-size:11px;box-shadow:0 4px 20px rgba(0,0,0,.8);font-family:system-ui;">
  <button id="playPauseBtn" style="background:#f6c453;color:#000;border:none;padding:5px 8px;border-radius:4px;cursor:pointer;font-weight:bold;font-size:12px;line-height:1;" onclick="togglePlayPause()">‚ñ∂</button>
  <span style="color:#a9b4d0;font-size:10px;">üéµ Waka Waka</span>
  <div style="width:80px;height:2px;background:rgba(255,255,255,.2);border-radius:1px;overflow:hidden;"><div id="progressBar" style="height:100%;background:#f6c453;width:0%;"></div></div>
</div>

<div class="container">
<h1>üèÜ FIFA 2026 FINAL</h1>

<div class="finalMatch" id="finalMatch"></div>

<div id="countdown" class="countdown"></div>
<div id="champion" class="champion"></div>
<div id="trophy" class="trophy"></div>
</div>

<button class="resetBtn" onclick="resetTournament()">Reset Tournament</button>

<script>

function initGlobalSong(){
  const song=document.getElementById('globalSong');
  const btn=document.getElementById('playPauseBtn');
  if(!song) return;
  song.volume=1;
  const t=parseFloat(sessionStorage.getItem('audioTime')||localStorage.getItem('songTime')||0);
  const wasPlaying=sessionStorage.getItem('audioPlaying')==='true'||localStorage.getItem('songPlaying')==='true';
  if(!isNaN(t) && t>0) song.currentTime=t;
  console.log('üéµ Final: time='+t.toFixed(1)+'s, wasPlaying='+wasPlaying);
  const updateProgress=()=>{
    const bar=document.getElementById('progressBar');
    if(bar && song.duration) bar.style.width=((song.currentTime/song.duration)*100)+'%';
  };
  setInterval(()=>{
    sessionStorage.setItem('audioTime',song.currentTime);
    localStorage.setItem('songTime',song.currentTime);
    updateProgress();
  },500);
  song.addEventListener('play',()=>{
    sessionStorage.setItem('audioPlaying','true');
    localStorage.setItem('songPlaying','true');
    if(btn) btn.textContent='‚è∏';
  });
  song.addEventListener('pause',()=>{
    sessionStorage.setItem('audioPlaying','false');
    localStorage.setItem('songPlaying','false');
    if(btn) btn.textContent='‚ñ∂';
  });
  if(btn) btn.textContent=wasPlaying?'‚è∏':'‚ñ∂';
  if(wasPlaying){
    song.play().then(()=>{
      console.log('‚úì Resumed on Final');
      if(btn) btn.textContent='‚è∏';
    }).catch(err=>{
      console.log('‚ö† Autoplay blocked');
      if(btn) btn.textContent='‚ñ∂';
    });
  }
}
function togglePlayPause(){
  const song=document.getElementById('globalSong');
  if(song.paused) song.play().catch(err=>console.warn('Play failed:',err.message));
  else song.pause();
}
document.addEventListener('DOMContentLoaded',initGlobalSong);

/* -------- LOAD SEMIFINAL WINNERS -------- */

document.addEventListener('DOMContentLoaded',()=>{
  console.log('Final page loading...');
  const stored = localStorage.getItem("semifinal_winners");
  console.log('Stored semifinal_winners:', stored);
  
  let teams = stored ? JSON.parse(stored) : null;

  // FALLBACK: Use test data if no semifinal winners found
  if(!teams || !Array.isArray(teams) || teams.length !== 2){
    console.warn('No semifinal winners found, using test data...');
    teams = [
      { name: "Brazil", perf: 85 },
      { name: "France", perf: 82 }
    ];
  }

  console.log('Teams loaded:', teams);
  const finalDiv=document.getElementById("finalMatch");
  
  if(!finalDiv){
    console.error('finalMatch div not found!');
    return;
  }

  finalDiv.innerHTML=`
  <div class="teams">
  <div class="team">${teams[0].name}</div>
  <div class="team">${teams[1].name}</div>
  </div>
  <button class="predictBtn" onclick="predictFinal()">
  Simulate Final (10,000 runs)
  </button>
  `;

  window.finalTeams = teams;
  console.log('Final page ready with teams:', window.finalTeams);
});

/* -------- MONTE CARLO FINAL -------- */

function predictFinal(){

const team1=window.finalTeams[0];
const team2=window.finalTeams[1];

const SIM=10000;
let t1Wins=0, t2Wins=0;

for(let s=0;s<SIM;s++){
const total=team1.perf+team2.perf;
const prob=team1.perf/total;
if(Math.random()<prob) t1Wins++;
else t2Wins++;
}

const t1Prob=(t1Wins/SIM)*100;
const t2Prob=(t2Wins/SIM)*100;

const winner = t1Prob>t2Prob ? team1 : team2;

localStorage.setItem("champion", JSON.stringify(winner));

let t=5;
const countdown=document.getElementById("countdown");
const championDiv=document.getElementById("champion");
const trophy=document.getElementById("trophy");

countdown.textContent="5";

const timer=setInterval(()=>{
t--;
countdown.textContent=t;

if(t<=0){
clearInterval(timer);
countdown.textContent="";

    // unlock audio with initial gesture
    const earlySong = document.getElementById("championSong");
    if(earlySong){
        earlySong.play().then(()=>earlySong.pause()).catch(()=>{});
    }

championDiv.innerHTML=`
üî• ${winner.name} WINS THE WORLD CUP! üî•<br><br>
${team1.name}: ${t1Prob.toFixed(2)}%<br>
${team2.name}: ${t2Prob.toFixed(2)}%
`;

		trophy.textContent="üèÜ";
		const song = document.getElementById("championSong");
		if(song){
			song.currentTime = 0;
			song.play().catch(()=>{});
		}
		startFireworks();
}

},1000);
}

/* -------- FIREWORKS CELEBRATION -------- */

let fireworkAnim;
let fwActive=false;

function startFireworks(){
	const canvas=document.getElementById("confetti");
	const ctx=canvas.getContext("2d");
	canvas.width=window.innerWidth;
	canvas.height=window.innerHeight;
	fwActive=true;
	let particles = [];

	function spawnFirework(){
		const x = Math.random()*canvas.width;
		const y = Math.random()*canvas.height*0.5;
		const count = 30 + Math.floor(Math.random()*30);
		for(let i=0;i<count;i++){
			const angle = Math.random()*Math.PI*2;
			const speed = Math.random()*4+1;
			particles.push({
				x,y,
			song.currentTime = 0;
			song.play().catch(err=>{
				console.warn("Could not play champion song:", err);
			});
				life:60 + Math.random()*30,
				color:`hsl(${Math.random()*360},100%,50%)`
			});
		}
	}

	function draw(){
		ctx.clearRect(0,0,canvas.width,canvas.height);
		particles.forEach((p,i)=>{
			ctx.globalAlpha = p.life/90;
			ctx.fillStyle=p.color;
			ctx.beginPath();
			ctx.arc(p.x,p.y,2,0,Math.PI*2);
			ctx.fill();
			p.x += p.vx;
			p.y += p.vy;
			p.life--;
			if(p.life<=0) particles.splice(i,1);
		});
		if(fwActive){
			if(Math.random()<0.08) spawnFirework();
			fireworkAnim = requestAnimationFrame(draw);
		}
	}
	draw();
}

function stopFireworks(){
	fwActive=false;
	cancelAnimationFrame(fireworkAnim);
}

/* -------- RESET -------- */

function resetTournament(){
	localStorage.clear();
	window.location.href="Fifa Simulation.html";
}

</script>

</body>
</html>